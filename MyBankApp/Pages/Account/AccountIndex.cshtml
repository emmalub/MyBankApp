@page
@model MyBankApp.Pages.Account.AccountIndexModel
@{
}
<section id="hero" class="hero section">
    @* <img src="assets/img/hero-bg-abstract.jpg" alt="" data-aos="fade-in" class=""> *@
    <div class="container">


        <div class="table-responsive">

            @if (Model.Account != null)
            {
                <h1>Transactions</h1>
                <h4><strong>Account Number:</strong> @Model.Account.AccountId</h4>
                <h5><strong>Balance:</strong> @Model.Account.Balance</h5>
                <br />
               
                <table class="table table-striped custom-table">
                    <thead>
                        <tr>
                            <th scope"col">
                                Date
                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Date"
                                   asp-route-sortOrder="asc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-up"></i>
                                </a>

                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Date"
                                   asp-route-sortOrder="desc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-down"></i>
                                </a>
                            </th>
                            <th scope"col">
                                Amount
                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Amount"
                                   asp-route-sortOrder="asc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-up"></i>
                                </a>

                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Amount"
                                   asp-route-sortOrder="desc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-down"></i>
                                </a>
                            </th>
                            <th scope"col">
                                Type
                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Type"
                                   asp-route-sortOrder="asc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-up"></i>
                                </a>

                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Type"
                                   asp-route-sortOrder="desc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-down"></i>
                                </a>
                            </th>
                            <th scope"col">
                                Balance
                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Type"
                                   asp-route-sortOrder="asc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-up"></i>
                                </a>

                                <a asp-page="/AccountIndex"
                                   asp-route-accountId="@Model.Account.AccountId"
                                   asp-route-sortColumn="Type"
                                   asp-route-sortOrder="desc"
                                   style="text-decoration:none">
                                    <i class="fa-solid fa-angle-down"></i>
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        @foreach (var t in Model.Transactions)
                        {
                            <tr>
                                <td>@t.Date.ToString("yyyy-MM-dd")</td>
                                <td>@t.Amount</td>
                                <td>@t.Type</td>
                                <td>@t.Balance</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Button to load more transactions -->
                @if (Model.TotalTransactions > Model.Transactions.Count)
                {
                    <button id="load-more" data-account-id="@Model.Account?.AccountId" class="btn btn-primary" data-page="2">Load More Transactions</button>
                }
            }
            else
            {
                <p>No account details found.</p>
            }

        </div>
    </div>
</div>
@section Scripts {
    <script>
               $(document).ready(function () {
            $('#load-more').click(function () {
                var button = $(this);
                var accountId = button.data('account-id');
                var pageNo = button.data('page'); // Hämta den aktuella sidan
                var skip = (pageNo - 1) * 20; // Beräkna hur många transaktioner vi ska hoppa över

                $.ajax({
                    url: '/AccountIndex?handler=Transactions',
                    type: 'GET',
                    data: {
                        accountId: accountId,
                        pageNo: pageNo
                    },
                    success: function (data) {
                        var tableBody = $('#transactions-table-body');

                        // Lägg till nya transaktioner i tabellen
                        data.forEach(function (transaction) {
                            var row = $('<tr></tr>');
                            row.append('<td>' + formatDate(transaction.date) + '</td>');
                            row.append('<td>' + transaction.amount.toFixed(2) + ' kr</td>');
                            row.append('<td>' + transaction.type + '</td>');
                            row.append('<td>' + transaction.balance.toFixed(2) + ' kr</td>');
                            tableBody.append(row);
                        });

                        // Uppdatera sidnummer för knappen
                        $('#load-more').data('page', pageNo + 1);

                        // Om alla transaktioner är laddade, dölja knappen
                        if (data.length < 20) {
                            $('#load-more').hide(); // Dölj knappen om inga fler transaktioner finns
                        }
                    },
                    error: function () {
                        alert("An error occurred while loading more transactions.");
                    }
                });
            });

            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleDateString('sv-SE');
            }
        });

    </script>
}
